# 尚硅谷嵌入式项目之水质水位监测（HAL库版本）

## 第 1 章 项目需求

### 1.1 项目概述

宠物定位器可用于获取宠物的当前位置。防止宠物丢失。此项目可以拓展至老人定位等需求。

### 1.2 功能描述

#### 1.2.1 宠物身上绑定定位器

宠物身上绑定定位器，主控芯片为 STM32F103C8T6 ，定位器开发板上的主要功能模块是：LoRa模块和4G-GPS模块。

工作流程：

1. 宠物通过4G-GPS模块获取自身的GPS定位信息。
2. 将GPS定位信息通过LoRa模块发送到主人身上的开发板。
3. 如果成功将定位信息发送到了主人身上携带的开发板，则主人身上携带的开发板可以通过蓝牙将定位信息发送到主人的手机上面并进行显示。
4. 如果通过LoRa模块发送定位信息失败，则通过4G将定位信息上传至服务器。同样可在主人的手机上显示定位信息。

#### 1.2.2 主人身上绑定定位信息接收器

定位信息接收器的主控芯片为 STM32F103ZET6 ，定位信息接收器上的主要功能模块是：LoRa模块和蓝牙模块。

工作流程：

1. 接收器接收来自宠物定位器的定位信息。
2. 接收器通过蓝牙将定位信息发送给手机并可视化。

### 1.3 系统总体设计

![](./总体架构图.png)

## 第 2 章 硬件架构

### 2.1 硬件选型

#### 2.1.1 宠物定位器硬件选型

- STM32F103C8T6
- LoRa模块(LLCC68)
- 4G-GPS模块(FS-MCore-F800E)

#### 2.1.2 定位信息接收器选型

- STM32F103ZET6
- LoRa模块(LLCC68)
- ESP32蓝牙模块

## 第 3 章 软件架构

### 3.1 宠物定位器软件架构

![](./宠物定位器软件架构.png)

### 3.2 定位信息接收器软件架构

![](./定位信息接收器软件架构.png)

## 第 4 章 背景知识

### 4.1 GPS定位原理

设GPS接收机的坐标信息是 $(x, y, z, t)$ 。卫星1的坐标信息是 $(x_1, y_1, z_1, t_1)$ 。卫星2的坐标信息是 $(x_2, y_2, z_2, t_2)$ 。卫星3的坐标信息是 $(x_3, y_3, z_3, t_3)$ 。卫星4的坐标信息是 $(x_4, y_4, z_4, t_4)$ 。

其中， $t_1, t_2, t_3, t_4$ 为各个卫星自身原子钟的时间。以下是方程组：

$$
c(t - t_1) = \sqrt{(x-x_1)^2+(y-y_1)^2+(z-z_1)^2} \\
c(t - t_2) = \sqrt{(x-x_2)^2+(y-y_2)^2+(z-z_2)^2} \\
c(t - t_3) = \sqrt{(x-x_3)^2+(y-y_3)^2+(z-z_3)^2} \\
c(t - t_4) = \sqrt{(x-x_4)^2+(y-y_4)^2+(z-z_4)^2}
$$

可以解出 4 个未知数： $(x,y,z,t)$ 。

方程组中每个方程的原理是：卫星和GPS接收机之间的距离使用欧几里得距离。同时也等于光速 $c$ 乘以 $(t-t_1)$ ，因为卫星在向GPS接收机发送信息时，自身的时间是 $t_1$ ，信息发送至GPS接收机时，GPS接收机自身的时间是： $t$ 。那么 $c(t-t_1)$ 自然就是卫星1和GPS接收机的距离。